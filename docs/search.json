[
  {
    "objectID": "ASME_08.html",
    "href": "ASME_08.html",
    "title": "8: Cox Regression",
    "section": "",
    "text": "Show the code\n# read \"dta\" files\nlibrary(haven) \n# create table\nlibrary(gtsummary)\n# data wrangling and other functions\nlibrary(tidyverse)\n# if you want to have a output similar to stata\nlibrary(tidylog)\n#cox\nlibrary(survival)\n# plots survival\nlibrary(ggsurvfit)\n# Limit significant digits to 2, remove scientific notation\noptions(digits = 2, scipen = 9)\n\n# Import the dataset\ntrin &lt;- read_dta(\"datasets/TRINMLSH.DTA\")\n\n#This contains data from a cohort study on cardiovascular risk factors and mortality among ~300 men from Trinidad.\n# Some data wrangling\n\ntrin &lt;- trin |&gt; \n  mutate(\n    ethgp = factor(ethgp,\n                      levels = c(1:5),\n                      labels = c(\"African\", \"Indian\", \"European\", \"mixed\", \"Chin/Sem\")),\n    alc = factor(alc,\n                      levels = c(0:3),\n                      labels = c(\"none\", \"1-4/wk\", \"5-14/wk\", \"&gt;=15/wk\")),\n    smoke3 = case_when(\n      smokenum == 0 ~ \"non-smok\",\n      smokenum == 1 ~ \"ex-smok\",\n      !is.na(smokenum) ~ \"smoker\"\n    ),\n    smoke3 = fct_relevel(smoke3, \"non-smok\"),\n    smokenum = factor(smokenum,\n                      levels = c(0:5),\n                      labels = c(\"non-smok\", \"ex-smok\", \"1-9/d\", \"10-19/d\", \"20-29/d\", \"&gt;=30/d\")),\n    chdstart = factor(chdstart,\n                      levels = c(0, 1),\n                      labels = c(\"no\", \"yes\")\n    ))\n\n\n\nQ1\nThe variables timein and timeout hold the dates of entry and exit into the study, while death is the indicator for mortality from any cause. Use stset with these variables, setting timein to be the origin (i.e. sort the records according to follow-up time, as in Figure 4).\nYou don’t need to do any of this (stset) in R. Each regression can have its own time setting!\n\n\nQ2\nExamine the effect of smoking on all-cause mortality using strate (or stptime if you prefer) and stcox. You may wish to recode smokenum into a smaller number of categories, say: 0=non-smoker, 1=ex-smoker, 2=current smoker.\nWe can now examine the smoking-specific mortality rates (per 1,000 person-years). Let’s first use the classical technique and then let’s use Cox regression.\n\nShow the code\n# Calculate rates\npyears(Surv(time = years, event=death) ~ smoke3, data = trin, scale = 1) %&gt;%\n  summary(n = F, rate = T, ci.r = T, scale = 1000)\n\nCall: pyears(formula = Surv(time = years, event = death) ~ smoke3, data = trin, scale = 1)\nnumber of observations = 317\n\n\n\nsmoke3\nEvents\nTime\nEvent rate\nCI (rate)\n\n\n\n\nnon-smok\n30\n984\n30\n21 - 44\n\n\nex-smok\n18\n462\n39\n23 - 62\n\n\nsmoker\n40\n749\n53\n38 - 73\n\n\n\n\nShow the code\n# Note that Surv() can take time data in two different formats: either a combination of data of entry and data of exit, or as a time # difference. In this case, `years` codes this time difference, so we'll use it.\n\n# Create Cox model\ncox_smok3 &lt;- coxph(Surv(time = years, event=death) ~ smoke3, data = trin)\n\n# Calculating 95% CIs for HRs\ntbl_regression(cox_smok3, exponentiate = T) |&gt; \n  add_n(location=\"level\") |&gt; \n  add_nevent(location=\"level\")\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nN\nEvent N\nHR\n95% CI\np-value\n\n\n\n\nsmoke3\n\n\n\n\n\n\n\n\n\n\n\n\n    non-smok\n140\n30\n—\n—\n\n\n\n\n    ex-smok\n68\n18\n1.29\n0.72, 2.32\n0.4\n\n\n    smoker\n109\n40\n1.75\n1.09, 2.81\n0.021\n\n\n\nAbbreviations: CI = Confidence Interval, HR = Hazard Ratio\n\n\n\n\n\n\n\nN is the size of the group\nEvent N is the number of events in that group\n\n\n\nQ3\nUsing the rates and rate ratios in part (2), can you see a trend in the relationship between smoking category and all-cause mortality? How would you assess this more formally? How would you present the results from your analyses in parts (2) and (3)?\n\n\nShow the code\n# Create Cox model\ncox_smok3 &lt;- coxph(Surv(time = years, event=death) ~ as.numeric(smoke3), data = trin)\n\n# Calculating 95% CIs for HRs\ntbl_regression(cox_smok3, exponentiate = T) |&gt; \n  add_n(location=\"level\") |&gt; \n  add_nevent(location=\"level\")\n\n\n\n\n\n\n\n\nCharacteristic\nN\nEvent N\nHR\n95% CI\np-value\n\n\n\n\nas.numeric(smoke3)\n317\n88\n1.32\n1.04, 1.68\n0.020\n\n\n\nAbbreviations: CI = Confidence Interval, HR = Hazard Ratio\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nAnswer\n\n\n\n\n\nYou can assess the trend formally by treating the smoke variable as numeric (ordinal in this case), so the model will evaluate if the increase in each point is associated with increase in the hazard.\n\n\n\n\n\nQ4\nConsider the possible confounding effect of current age on the relationship between smoking and mortality. By examining the data (but without performing any further modelling) would you expect a Cox model controlling for current age to give different results to one controlling for time in the study? Now perform a Cox model to investigate this.\n\n\n\n\n\n\nAnswer\n\n\n\n\n\nNote that in question 2 the Cox model has adjusted for time in the study i.e. everyone is followed up from the time they enter the study and when an event occurs the comparison is with others who have the same amount of follow-up and not with others of the same age. If there are differences in age between the three groups then we would expect an analysis controlling for current age to show confounding (since mortality increases with age). One indicator of this would be the age at entry in the three groups.\n\n\n\n\n\nShow the code\ntrin |&gt; \n  tbl_summary(include = ageent, by = smoke3) |&gt; \n  modify_caption(\"Age by smoke status\")\n\n\n\n\n\n\nAge by smoke status\n\n\n\n\n\n\n\n\nCharacteristic\nnon-smok N = 1401\nex-smok N = 681\nsmoker N = 1091\n\n\n\n\nAge in years at first survey\n64.52 (62.32, 67.68)\n65.32 (62.47, 68.73)\n64.40 (62.48, 66.44)\n\n\n\n1 Median (Q1, Q3)\n\n\n\n\n\n\n\n\nShow the code\n# Survival object set for current age\n# Cox using the timeage as the time \ncox_smok3_age &lt;- coxph(Surv(time=as.numeric(timein),time2=as.numeric(timeout),\n                             event = death,\n                             origin = as.numeric(timebth)) ~ smoke3, data = trin)\n\ntbl_regression(cox_smok3_age, exponentiate = T) |&gt; \n  add_n(location=\"level\") |&gt; \n  add_nevent(location=\"level\")\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nN\nEvent N\nHR\n95% CI\np-value\n\n\n\n\nsmoke3\n\n\n\n\n\n\n\n\n\n\n\n\n    non-smok\n140\n30\n—\n—\n\n\n\n\n    ex-smok\n68\n18\n1.28\n0.71, 2.29\n0.4\n\n\n    smoker\n109\n40\n1.77\n1.10, 2.85\n0.018\n\n\n\nAbbreviations: CI = Confidence Interval, HR = Hazard Ratio\n\n\n\n\n\n\n\n\n\n\nQ5\nUsing PBC1BAS dataset\n\n\nShow the code\n# some data wrangling\n# Read in the pbc1bas.dta dataset \npbc &lt;- read_dta(\"datasets/PBC1BAS.DTA\")\n\n# Data management\npbc&lt;- pbc |&gt; mutate(death = d,\n               treat = factor(treat, levels = c(1, 2), labels = c(\"placebo\", \"azath\")),\n               cenc0 = factor(cenc0, levels = c(0, 1), labels = c(\"no\", \"yes\")),\n               cir0 = factor(cir0, levels = c(0, 1), labels = c(\"no\", \"yes\")),\n               gh0 = factor(gh0, levels = c(0, 1), labels = c(\"no\", \"yes\")),\n               asc0 = factor(asc0, levels = c(0, 1), labels = c(\"no\", \"yes\"))) |&gt; \n         select(-d)\n\n\nUse a Poisson model to assess the relationship between treatment and mortality adjusting for baseline bilirubin (logb0). How do the results compare to those from using a Cox model?\n\n\nShow the code\n# Poisson model\nmod_pois &lt;- glm(death ~ offset(log(time)) + treat + logb0, family = poisson, data = pbc) \n\ntbl_pois &lt;- tbl_regression(mod_pois,exponentiate = T)\n\n# Cox model\nmod_cox &lt;- coxph(Surv(time,death) ~ treat + logb0, data = pbc)\ntbl_cox &lt;- tbl_regression(mod_cox,exponentiate = T)\n\ntbl_merge(list(tbl_pois,tbl_cox))\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\n\nTable 1\n\n\nTable 2\n\n\n\nIRR\n95% CI\np-value\nHR\n95% CI\np-value\n\n\n\n\ntreat\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n    placebo\n—\n—\n\n\n—\n—\n\n\n\n\n    azath\n0.73\n0.49, 1.10\n0.13\n0.65\n0.43, 0.99\n0.044\n\n\nLob Bilirubin at entry\n7.23\n4.64, 11.3\n&lt;0.001\n10.6\n6.42, 17.6\n&lt;0.001\n\n\n\nAbbreviations: CI = Confidence Interval, HR = Hazard Ratio, IRR = Incidence Rate Ratio\n\n\n\n\n\n\n\n\nShow the code\ntbl_merge(list(tbl_pois,tbl_cox),\n          tab_spanner = c(\"**Poisson**\", \"**Cox**\"))\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\n\nPoisson\n\n\nCox\n\n\n\nIRR\n95% CI\np-value\nHR\n95% CI\np-value\n\n\n\n\ntreat\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n    placebo\n—\n—\n\n\n—\n—\n\n\n\n\n    azath\n0.73\n0.49, 1.10\n0.13\n0.65\n0.43, 0.99\n0.044\n\n\nLob Bilirubin at entry\n7.23\n4.64, 11.3\n&lt;0.001\n10.6\n6.42, 17.6\n&lt;0.001\n\n\n\nAbbreviations: CI = Confidence Interval, HR = Hazard Ratio, IRR = Incidence Rate Ratio\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nAnswer\n\n\n\n\n\nThe results from the Cox model provide more evidence for an impact of treatment (from the hazard ratios, 95% CIs and the p-values). However, the Cox model adjusts for time in the study as well as baseline bilirubin whereas the Poisson model adjusts for baseline bilirubin only.\n\n\n\n\n\nQ6\nIn order to make a like for like comparison with the Cox model, what would be a more appropriate analysis using streg (survSplit in R / other functions (see Epi package)) and what do the results from this analysis indicate?\n\n\nShow the code\n# Split the survival object\npbc_split &lt;- survSplit(Surv(time,death) ~ .,\n                       data = pbc,\n                       cut = c(2, 4, 6),\n                       episode = \"period\",\n                       start = \"tstart\",\n                       end = \"tstop\")\n\n# Fix age and create follow-up by band\npbc_split &lt;- pbc_split |&gt; \n  mutate(\n    age = age + tstart,\n    t_fup = tstop - tstart\n  )\n\n\n# Factorise variable and label values\npbc_split$period &lt;- factor(pbc_split$period,\n                           levels = c(1, 2, 3, 4),\n                           labels = c(\"0-2y\", \"2-4y\", \"4-6y\", \"6-12y\"))\nglm(death ~ offset(log(t_fup)) + treat + logb0 + period,   # period goes here\n    family = poisson(),\n    data = pbc_split) |&gt; \n  tbl_regression(exponentiate = T)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nIRR\n95% CI\np-value\n\n\n\n\ntreat\n\n\n\n\n\n\n\n\n    placebo\n—\n—\n\n\n\n\n    azath\n0.64\n0.42, 0.96\n0.032\n\n\nlogb0\n11.1\n6.78, 18.4\n&lt;0.001\n\n\nperiod\n\n\n\n\n\n\n\n\n    0-2y\n—\n—\n\n\n\n\n    2-4y\n1.21\n0.70, 2.05\n0.5\n\n\n    4-6y\n2.46\n1.38, 4.28\n0.002\n\n\n    6-12y\n4.67\n2.39, 8.84\n&lt;0.001\n\n\n\nAbbreviations: CI = Confidence Interval, IRR = Incidence Rate Ratio\n\n\n\n\n\n\n\n\nIf you split the time in a more granular way, the results will be even closer!\n\n\nShow the code\n# Split the survival object\npbc_split &lt;- survSplit(Surv(time,death) ~ .,\n                       data = pbc,\n                       cut = c(2,3,4,5,6,7,8,9),\n                       episode = \"period\",\n                       start = \"tstart\",\n                       end = \"tstop\")\n\n# Fix age and create follow-up by band\npbc_split &lt;- pbc_split |&gt; \n  mutate(\n    age = age + tstart,\n    t_fup = tstop - tstart\n  )\n\n\n# Factorise variable and label values\npbc_split$period &lt;- as.factor(pbc_split$period)\nglm(death ~ offset(log(t_fup)) + treat + logb0 + period,   # period goes here\n    family = poisson(),\n    data = pbc_split) |&gt; \n  tbl_regression(exponentiate = T, include = treat)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nIRR\n95% CI\np-value\n\n\n\n\ntreat\n\n\n\n\n\n\n\n\n    placebo\n—\n—\n\n\n\n\n    azath\n0.65\n0.43, 0.98\n0.040\n\n\n\nAbbreviations: CI = Confidence Interval, IRR = Incidence Rate Ratio\n\n\n\n\n\n\n\n\n\n\nQ7\nUse a Cox regression model to estimate the effect of grade (coded: 1=high; 2=low) using first the follow-up time scale. Then check whether current age is a confounder using both Cox and Poisson regression.\n\n\nShow the code\nwhitehall &lt;- read_stata(\"datasets/WHITEHAL.DTA\")\n\n# Factorise job grade\nwhitehall$grade &lt;- factor(whitehall$grade,\n                          levels = c(1, 2),\n                          labels = c(\"higher\", \"lower\"))\n\n\n\n\nShow the code\n# Cox\ncox_time &lt;- coxph(Surv(\n  as.numeric(timein),\n  as.numeric(timeout),\n  event = chd\n) ~ grade, data = whitehall)\n\ntbl_time &lt;- tbl_regression(cox_time, exponentiate = T)\n# Cox\ncox_age &lt;- coxph(Surv(\n  as.numeric(timein),\n  as.numeric(timeout),\n  event = chd,\n  origin = as.numeric(timebth)\n) ~ grade, data = whitehall)\ntbl_age &lt;- tbl_regression(cox_age, exponentiate = T)\n\ntbl_merge(list(tbl_time,tbl_age),\n         tab_spanner = c(\"**Time since followup**\", \"**Age**\") )\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\n\nTime since followup\n\n\nAge\n\n\n\nHR\n95% CI\np-value\nHR\n95% CI\np-value\n\n\n\n\ngrade\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n    higher\n—\n—\n\n\n—\n—\n\n\n\n\n    lower\n2.04\n1.48, 2.81\n&lt;0.001\n1.41\n1.01, 1.95\n0.043\n\n\n\nAbbreviations: CI = Confidence Interval, HR = Hazard Ratio\n\n\n\n\n\n\n\n\n\n\nShow the code\n# Split the survival object\nsplit_white &lt;- survSplit(Surv(\n  as.numeric(timein),\n  as.numeric(timeout),\n  event = chd,\n  origin = as.numeric(timebth)\n) ~ .,\n                         data = whitehall,\n                         cut = c(50*365.25, 60*365.25, 70*365.25,\n                                 80*365.25),\n                         episode = \"age\",\nstart = \"tstart\",\nend = \"tstop\")\n\n# Factorise variable and label values\nsplit_white$age &lt;- factor(split_white$age,\n                          levels = c(1, 2, 3, 4,5),\n                          labels = c(\"&lt;=50\", \"51-60\", \"61-70\", \n                                     \"71-80\",\n                                     \"&gt;80\"))\n\nsplit_white &lt;- split_white  |&gt; \n  mutate(\n    pyears=as.numeric(tstop - tstart))\n\n#Fit a Poisson model\nglm(chd ~ offset(log(pyears)) + grade + age,   \n    family = poisson(),\n    data = split_white) |&gt; \n  tbl_regression(exponentiate = T)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nIRR\n95% CI\np-value\n\n\n\n\ngrade\n\n\n\n\n\n\n\n\n    higher\n—\n—\n\n\n\n\n    lower\n1.45\n1.04, 2.01\n0.027\n\n\nage\n\n\n\n\n\n\n\n\n    &lt;=50\n—\n—\n\n\n\n\n    51-60\n7.67\n1.63, 137\n0.045\n\n\n    61-70\n22.1\n4.90, 390\n0.002\n\n\n    71-80\n36.6\n7.95, 649\n&lt;0.001\n\n\n    &gt;80\n87.7\n12.9, 1,723\n&lt;0.001\n\n\n\nAbbreviations: CI = Confidence Interval, IRR = Incidence Rate Ratio\n\n\n\n\n\n\n\n\n\n\nOptional\nThink whether you should test for interaction between grade and current age. If so how would you do this using a Poisson model and what are the problems of assessing such an interaction using a Cox model?\n\n\nShow the code\n#Fit a Poisson model\npoisson_without &lt;- glm(chd ~ offset(log(pyears)) + grade + age,   \n    family = poisson(),\n    data = split_white)\npoisson_interaction &lt;- glm(chd ~ offset(log(pyears)) + grade * age,   \n    family = poisson(),\n    data = split_white)\nlmtest::lrtest(poisson_without,poisson_interaction)\n\n\nLikelihood ratio test\n\nModel 1: chd ~ offset(log(pyears)) + grade + age\nModel 2: chd ~ offset(log(pyears)) + grade * age\n  #Df LogLik Df Chisq Pr(&gt;Chisq)  \n1   6   -748                      \n2  10   -741  4    13      0.011 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nYou can also test that with cox regression. If the model is using age as the underlying timescale. The survival packages has inbuilt function for that. The cox.zph function will test proportionality of all the predictors in the model by creating interactions with time using the transformation of time (default is log) specified in the transform option. And you can also plot the effect by time\n\n\nShow the code\ncox.zph(cox_age)\n\n\n       chisq df     p\ngrade   6.23  1 0.013\nGLOBAL  6.23  1 0.013\n\n\nShow the code\nplot(cox.zph(cox_age))",
    "crumbs": [
      "8: Cox Regression"
    ]
  },
  {
    "objectID": "ASME_08.html#data-manipulation",
    "href": "ASME_08.html#data-manipulation",
    "title": "Cox Regression",
    "section": "1. Data manipulation",
    "text": "1. Data manipulation\nRead in dataset trinmlsh.dta. This contains data from a cohort study on cardiovascular risk factors and mortality among ~300 men from Trinidad.\n\n\nShow the code\n# Import the dataset\ntrin &lt;- read_dta(\"datasets/TRINMLSH.DTA\")\ntrin &lt;- trin |&gt; \n  mutate(\n    ethgp = factor(ethgp,\n                      levels = c(1:5),\n                      labels = c(\"African\", \"Indian\", \"European\", \"mixed\", \"Chin/Sem\")),\n    alc = factor(alc,\n                      levels = c(0:3),\n                      labels = c(\"none\", \"1-4/wk\", \"5-14/wk\", \"&gt;=15/wk\")),\n    smoke3 = case_when(\n      smokenum == 0 ~ \"non-smok\",\n      smokenum == 1 ~ \"ex-smok\",\n      !is.na(smokenum) ~ \"smoker\"\n    ),\n    smoke3 = fct_relevel(smoke3, \"non-smok\"),\n    smokenum = factor(smokenum,\n                      levels = c(0:5),\n                      labels = c(\"non-smok\", \"ex-smok\", \"1-9/d\", \"10-19/d\", \"20-29/d\", \"&gt;=30/d\")),\n    chdstart = factor(chdstart,\n                      levels = c(0, 1),\n                      labels = c(\"no\", \"yes\")\n    ))"
  },
  {
    "objectID": "ASME_08.html#section",
    "href": "ASME_08.html#section",
    "title": "Cox Regression",
    "section": "2",
    "text": "2\nExamine the effect of smoking on all-cause mortality using strate (or stptime if you prefer) and stcox. You may wish to recode smokenum into a smaller number of categories, say: 0=non-smoker, 1=ex-smoker, 2=current smoker.\nWe can now examine the smoking-specific mortality rates (per 1,000 person-years). Let’s first use the classical technique and then let’s use Cox regression.\n\nShow the code\n# Now create a survival object to assess all-cause mortality, coded as `death`. Note that Surv() can take time data in two different formats: either a combination of data of entry and data of exit (like in session 7), or as a time difference. In this case, `years` codes this time difference, so we'll use it.\n# Calculate rates\npyears(Surv(time = years, event=death) ~ smoke3, data = trin, scale = 1) %&gt;%\n  summary(n = F, rate = T, ci.r = T, scale = 1000)\n\nCall: pyears(formula = Surv(time = years, event = death) ~ smoke3, data = trin, scale = 1)\nnumber of observations = 317\n\n\n\nsmoke3\nEvents\nTime\nEvent rate\nCI (rate)\n\n\n\n\nnon-smok\n30\n984\n30\n21 - 44\n\n\nex-smok\n18\n462\n39\n23 - 62\n\n\nsmoker\n40\n749\n53\n38 - 73"
  },
  {
    "objectID": "ASME_02.html",
    "href": "ASME_02.html",
    "title": "2: Review of Logistic Regression",
    "section": "",
    "text": "All code solutions are hidden by default, you can see the underlying code clicking in “Show the code”",
    "crumbs": [
      "Home",
      "2: Review of Logistic Regression"
    ]
  },
  {
    "objectID": "ASME_02.html#a",
    "href": "ASME_02.html#a",
    "title": "2: Review of Logistic Regression",
    "section": "2a",
    "text": "2a\n\nObtain a frequency table of npa. What is the most commonly occurring number of lifetime sexual partners? Where npa is missing (9) recode to STATA’s own missing value code (.) using the command mvdecode or recode. Form a cross-tabulation of number of lifetime sexual partners with HIV status.\n\n\n\nShow the code\nmwanza |&gt; tbl_summary(include = c(npa))\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nN = 7631\n\n\n\n\nnpa\n\n\n\n\n    1\n200 (27%)\n\n\n    2\n369 (50%)\n\n\n    3\n123 (17%)\n\n\n    4\n43 (5.9%)\n\n\n    Unknown\n28\n\n\n\n1 n (%)\n\n\n\n\n\n\n\n\nWhat is the most common number of lifetime sexual partners?\nCross-tabulate number of lifetime sexual partners with HIV status.\n\n\nShow the code\nmwanza |&gt; tbl_summary(include = c(npa), by = case)\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\n0 N = 5741\n1 N = 1891\n\n\n\n\nnpa\n\n\n\n\n\n\n    1\n173 (31%)\n27 (15%)\n\n\n    2\n277 (50%)\n92 (50%)\n\n\n    3\n83 (15%)\n40 (22%)\n\n\n    4\n19 (3.4%)\n24 (13%)\n\n\n    Unknown\n22\n6\n\n\n\n1 n (%)",
    "crumbs": [
      "Home",
      "2: Review of Logistic Regression"
    ]
  },
  {
    "objectID": "ASME_02.html#b",
    "href": "ASME_02.html#b",
    "title": "2: Review of Logistic Regression",
    "section": "2b",
    "text": "2b\n\nFit a logistic model to estimate the strength of association between npa and HIV status, treating npa as a factor. Is there evidence for an association between npa and HIV? What do you conclude?\n\n\n\nShow the code\nglm(case ~ npa,\n    family = binomial,\n    data = mwanza) |&gt; \n  tbl_regression(exponentiate = T) |&gt; \n  add_global_p(keep=T)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nOR\n95% CI\np-value\n\n\n\n\nnpa\n\n\n\n\n&lt;0.001\n\n\n    1\n—\n—\n\n\n\n\n    2\n2.13\n1.35, 3.46\n0.002\n\n\n    3\n3.09\n1.78, 5.42\n&lt;0.001\n\n\n    4\n8.09\n3.95, 17.0\n&lt;0.001\n\n\n\nAbbreviations: CI = Confidence Interval, OR = Odds Ratio\n\n\n\n\n\n\n\n\nIs there evidence of association?\n\n\n\n\n\n\nAnswer\n\n\n\n\n\nThere is strong evidence of an association between the number of lifetime partners and being HIV positive.",
    "crumbs": [
      "Home",
      "2: Review of Logistic Regression"
    ]
  },
  {
    "objectID": "ASME_02.html#c",
    "href": "ASME_02.html#c",
    "title": "2: Review of Logistic Regression",
    "section": "2c",
    "text": "2c\nA more convenient way to fit this model is to use the most prevalent group as a baseline. Which group was used in (b)? Why does it make sense to use the most prevalent group as baseline? Refit the model using the most prevalent group as baseline.\n\n\nShow the code\n# Relevel the factor\nmwanza &lt;- mwanza |&gt; \n  # the first argument of fct_relevel is the variable and the second argument the level you \n  # want to be the reference level\n  mutate(npa = fct_relevel(npa,\"2\")) \n\n# Logistic regression (unchanged)\nglm(case ~ npa,\n    family = binomial,\n    data = mwanza) |&gt; \n  tbl_regression(exponentiate = T) |&gt; \n  add_global_p(keep=T)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nOR\n95% CI\np-value\n\n\n\n\nnpa\n\n\n\n\n&lt;0.001\n\n\n    2\n—\n—\n\n\n\n\n    1\n0.47\n0.29, 0.74\n0.002\n\n\n    3\n1.45\n0.92, 2.26\n0.10\n\n\n    4\n3.80\n2.00, 7.34\n&lt;0.001\n\n\n\nAbbreviations: CI = Confidence Interval, OR = Odds Ratio\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nAnswer\n\n\n\n\n\nIf we use the most prevalent group as the baseline, then the SEs for the \\(\\beta\\)s (log(OR)) will be smaller.",
    "crumbs": [
      "Home",
      "2: Review of Logistic Regression"
    ]
  },
  {
    "objectID": "ASME_02.html#d",
    "href": "ASME_02.html#d",
    "title": "2: Review of Logistic Regression",
    "section": "2d",
    "text": "2d\nAmend your model to control for the confounding effect of age treated as a factor (age1).\n\n\nShow the code\nglm(case ~ npa + age1,\n    family = binomial,\n    data = mwanza) |&gt; \n  tbl_regression(exponentiate = T) |&gt; \n  add_global_p(keep=T)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nOR\n95% CI\np-value\n\n\n\n\nnpa\n\n\n\n\n&lt;0.001\n\n\n    2\n—\n—\n\n\n\n\n    1\n0.51\n0.31, 0.81\n0.006\n\n\n    3\n1.30\n0.82, 2.04\n0.3\n\n\n    4\n4.75\n2.43, 9.47\n&lt;0.001\n\n\nage1\n\n\n\n\n&lt;0.001\n\n\n    1\n—\n—\n\n\n\n\n    2\n3.27\n1.69, 6.69\n&lt;0.001\n\n\n    3\n2.50\n1.24, 5.28\n0.013\n\n\n    4\n1.93\n0.93, 4.15\n0.082\n\n\n    5\n1.26\n0.61, 2.73\n0.5\n\n\n    6\n0.81\n0.35, 1.87\n0.6\n\n\n\nAbbreviations: CI = Confidence Interval, OR = Odds Ratio\n\n\n\n\n\n\n\n\nShow the code\n# if you want to see the more details about the overall signficance of each variable\n# anova(glm(case ~ npa + age1,\n#     family = binomial,\n#     data = mwanza))\n\n\nWhat is your conclusion?\n\n\n\n\n\n\nAnswer\n\n\n\n\n\nAdding age1 to the model changes the odds ratios for npa (0.51, 1.30, 4.75) showing the confounding effect of age. After adjusting for age, there is strong evidence that npa is associated with being a case (LRT gives X32=35.44, p&lt;0.001).",
    "crumbs": [
      "Home",
      "2: Review of Logistic Regression"
    ]
  },
  {
    "objectID": "ASME_02.html#e.-summary-table",
    "href": "ASME_02.html#e.-summary-table",
    "title": "2: Review of Logistic Regression",
    "section": "2e. Summary table",
    "text": "2e. Summary table\nSummarise the results of the analyses conducted above in a table - show the distribution of number of partners in cases and controls, odds ratios (unadjusted and age-adjusted effect of number of lifetime partners in a table), 95% CIs, p-values.\n\n\nShow the code\n# you can do all three itens in almost one line of code (in R)\n\nlibrary(finalfit)\n\nexplanatory = c(\"npa\", \"age1\")\ndependent = \"case\"\nmwanza |&gt; \n    finalfit(dependent, explanatory) -&gt; table1\nknitr::kable(table1, row.names=FALSE, align=c(\"l\", \"l\", \"r\", \"r\", \"r\"))\n\n\n\n\n\n\n\n\n\n\n\n\n\nDependent: case\n\n0\n1\nOR (univariable)\nOR (multivariable)\n\n\n\n\nnpa\n2\n277 (75.1)\n92 (24.9)\n-\n-\n\n\n\n1\n173 (86.5)\n27 (13.5)\n0.47 (0.29-0.74, p=0.002)\n0.51 (0.31-0.81, p=0.006)\n\n\n\n3\n83 (67.5)\n40 (32.5)\n1.45 (0.92-2.26, p=0.101)\n1.30 (0.82-2.04, p=0.264)\n\n\n\n4\n19 (44.2)\n24 (55.8)\n3.80 (2.00-7.34, p&lt;0.001)\n4.75 (2.43-9.47, p&lt;0.001)\n\n\nage1\n1\n96 (88.1)\n13 (11.9)\n-\n-\n\n\n\n2\n108 (65.5)\n57 (34.5)\n3.90 (2.07-7.84, p&lt;0.001)\n3.27 (1.69-6.69, p=0.001)\n\n\n\n3\n84 (68.3)\n39 (31.7)\n3.43 (1.75-7.08, p&lt;0.001)\n2.50 (1.24-5.28, p=0.013)\n\n\n\n4\n85 (72.0)\n33 (28.0)\n2.87 (1.45-5.98, p=0.003)\n1.93 (0.93-4.15, p=0.082)\n\n\n\n5\n107 (78.1)\n30 (21.9)\n2.07 (1.04-4.32, p=0.044)\n1.26 (0.61-2.73, p=0.539)\n\n\n\n6\n94 (84.7)\n17 (15.3)\n1.34 (0.62-2.95, p=0.465)\n0.81 (0.35-1.87, p=0.612)",
    "crumbs": [
      "Home",
      "2: Review of Logistic Regression"
    ]
  },
  {
    "objectID": "ASME_02.html#a-1",
    "href": "ASME_02.html#a-1",
    "title": "2: Review of Logistic Regression",
    "section": "3a",
    "text": "3a\nThe risk of HIV associated with npa is confounded by attending school (using ed2)\n\n\nShow the code\nglm(case ~ npa + age1 + ed2,\n    family = binomial,\n    data = mwanza) |&gt; \n  tbl_regression(exponentiate = T) |&gt; \n  add_global_p(keep=T)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nOR\n95% CI\np-value\n\n\n\n\nnpa\n\n\n\n\n&lt;0.001\n\n\n    2\n—\n—\n\n\n\n\n    1\n0.50\n0.30, 0.81\n0.006\n\n\n    3\n1.24\n0.78, 1.96\n0.4\n\n\n    4\n4.38\n2.22, 8.82\n&lt;0.001\n\n\nage1\n\n\n\n\n0.003\n\n\n    1\n—\n—\n\n\n\n\n    2\n3.20\n1.66, 6.56\n&lt;0.001\n\n\n    3\n2.62\n1.30, 5.56\n0.009\n\n\n    4\n2.28\n1.09, 4.97\n0.031\n\n\n    5\n1.59\n0.75, 3.49\n0.2\n\n\n    6\n1.26\n0.52, 3.06\n0.6\n\n\ned2\n\n\n\n\n0.001\n\n\n    0\n—\n—\n\n\n\n\n    1\n1.97\n1.30, 3.04\n0.002\n\n\n\nAbbreviations: CI = Confidence Interval, OR = Odds Ratio\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nAnswer\n\n\n\n\n\nEducational status does not appear to be a strong confounder of the relationship between npa and HIV-infection, after adjusting for age1 as the adjusted ORs are 0.50, 1.24, and 4.38, in similar to the adjusted ORs reported in 2",
    "crumbs": [
      "Home",
      "2: Review of Logistic Regression"
    ]
  },
  {
    "objectID": "ASME_02.html#b.",
    "href": "ASME_02.html#b.",
    "title": "2: Review of Logistic Regression",
    "section": "3b.",
    "text": "3b.\nThere is any evidence the risk of HIV associated with npa differs according to whether the women had attended school.\n\n\nShow the code\n# Model with interaction\nlogit_inter &lt;- glm(case ~ npa * ed2 + age1,\n    family = binomial,\n    data = mwanza)\n\n# Model without interaction\nlogit_without &lt;- glm(case ~ npa + ed2 + age1,\n    family = binomial,\n    data = mwanza)\n\n# Likelihood ratio test\nlmtest::lrtest(logit_without, logit_inter)\n\n\nLikelihood ratio test\n\nModel 1: case ~ npa + ed2 + age1\nModel 2: case ~ npa * ed2 + age1\n  #Df LogLik Df Chisq Pr(&gt;Chisq)\n1  10   -374                    \n2  13   -373  3   0.5       0.92\n\n\nShow the code\n# Note that ANOVA gives you the same χ statistic and df\n#anova(logit_without, logit_inter)\n\n\n\n\n\n\n\n\nAnswer\n\n\n\n\n\nLRT gives \\(\\chi_{3}^2\\)=0.50, p=0.92 suggesting data are compatible with no interaction between lifetime partners and educational status on HIV status.",
    "crumbs": [
      "Home",
      "2: Review of Logistic Regression"
    ]
  },
  {
    "objectID": "ASME_02.html#a-2",
    "href": "ASME_02.html#a-2",
    "title": "2: Review of Logistic Regression",
    "section": "4a",
    "text": "4a\nFit a model including npa, age1 and their interaction, all terms treated as categorical variables.\n\nWhat happens when you carry out a LR test of the interaction term?\n\n\n\nShow the code\n# You will get multiple warnings of non convergence / fitted probabilities of 0/1\nglm(case ~ npa * age1,\n    family = binomial,\n    data = mwanza)|&gt; \n  tbl_regression(exponentiate = T) |&gt; \n  add_global_p(keep=T)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nOR\n95% CI\np-value\n\n\n\n\nnpa\n\n\n\n\n0.025\n\n\n    2\n—\n—\n\n\n\n\n    1\n0.44\n0.10, 1.78\n0.2\n\n\n    3\n6.40\n1.19, 36.7\n0.030\n\n\n    4\n0.00\n\n\n&gt;0.9\n\n\nage1\n\n\n\n\n&lt;0.001\n\n\n    1\n—\n—\n\n\n\n\n    2\n3.98\n1.52, 12.6\n0.009\n\n\n    3\n3.20\n1.14, 10.5\n0.037\n\n\n    4\n2.23\n0.77, 5.40\n0.2\n\n\n    5\n1.60\n0.55, 5.32\n0.4\n\n\n    6\n0.70\n0.24, 2.60\n0.6\n\n\nnpa * age1\n\n\n\n\n0.2\n\n\n    1 * 2\n1.06\n0.20, 5.62\n&gt;0.9\n\n\n    3 * 2\n0.22\n0.03, 1.43\n0.11\n\n\n    4 * 2\n97,773\n0.00,\n\n&gt;0.9\n\n\n    1 * 3\n0.62\n0.08, 4.12\n0.6\n\n\n    3 * 3\n0.18\n0.04, 1.20\n0.076\n\n\n    4 * 3\n1,217,553\n0.00,\n\n&gt;0.9\n\n\n    1 * 4\n1.62\n0.24, 10.5\n0.6\n\n\n    3 * 4\n0.18\n0.02, 1.33\n0.095\n\n\n    4 * 4\n523,548\n0.00,\n\n&gt;0.9\n\n\n    1 * 5\n0.70\n0.07, 5.21\n0.7\n\n\n    3 * 5\n0.10\n0.01, 0.81\n0.035\n\n\n    4 * 5\n1,095,798\n0.00,\n\n&gt;0.9\n\n\n    1 * 6\n5.19\n0.77, 35.7\n0.088\n\n\n    3 * 6\n0.20\n0.02, 2.81\n0.3\n\n\n    4 * 6\n478,324\n0.00,\n\n&gt;0.9\n\n\n\nAbbreviations: CI = Confidence Interval, OR = Odds Ratio\n\n\n\n\n\n\n\n\n\nTabulate the number of cases in each grouping of npa vs age1 (see note below).\n\n\n\nShow the code\nmwanza |&gt; tbl_summary(include = c(age1), by = npa)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\n2 N = 3691\n1 N = 2001\n3 N = 1231\n4 N = 431\n\n\n\n\nage1\n\n\n\n\n\n\n\n\n\n\n    1\n37 (10%)\n62 (31%)\n8 (6.5%)\n1 (2.3%)\n\n\n    2\n86 (23%)\n40 (20%)\n28 (23%)\n3 (7.0%)\n\n\n    3\n57 (15%)\n25 (13%)\n33 (27%)\n6 (14%)\n\n\n    4\n58 (16%)\n20 (10%)\n24 (20%)\n10 (23%)\n\n\n    5\n70 (19%)\n28 (14%)\n22 (18%)\n13 (30%)\n\n\n    6\n61 (17%)\n25 (13%)\n8 (6.5%)\n10 (23%)\n\n\n\n1 n (%)\n\n\n\n\n\n\n\n\n\nWhat is the problem and how can it be resolved? ::: {.callout-note collapse=“true”} ## Answer\n\nThis problem arises because there are no cases in the highest sex partner group and the youngest age group. Sparse data (bias), other names is complete/quasi separation problem. :::",
    "crumbs": [
      "Home",
      "2: Review of Logistic Regression"
    ]
  },
  {
    "objectID": "ASME_02.html#b-1",
    "href": "ASME_02.html#b-1",
    "title": "2: Review of Logistic Regression",
    "section": "4b",
    "text": "4b\nIn order to test for interaction we need to combine npa group 4 with npa group 3. Generate a new variable (eg npa2) with this regrouping. Refit the interaction model using npa2 in place of npa. Is there evidence of any interaction?\n\n\nShow the code\n# Create a new variable, relevel and label\nmwanza &lt;- mwanza |&gt; \n  mutate(partners = case_when(npa == \"1\" ~ \"&lt;=1\",\n              npa == \"2\" ~ \"2-4\",\n              npa == \"3\" | npa == \"4\" ~ \"&gt;=5\"),\n    partners = fct_relevel(partners,\"2-4\")\n  )\n\n# Check it worked well\nmwanza |&gt; tbl_summary(include = c(age1), by = partners)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\n2-4 N = 3691\n&lt;=1 N = 2001\n&gt;=5 N = 1661\n\n\n\n\nage1\n\n\n\n\n\n\n\n\n    1\n37 (10%)\n62 (31%)\n9 (5.4%)\n\n\n    2\n86 (23%)\n40 (20%)\n31 (19%)\n\n\n    3\n57 (15%)\n25 (13%)\n39 (23%)\n\n\n    4\n58 (16%)\n20 (10%)\n34 (20%)\n\n\n    5\n70 (19%)\n28 (14%)\n35 (21%)\n\n\n    6\n61 (17%)\n25 (13%)\n18 (11%)\n\n\n\n1 n (%)\n\n\n\n\n\n\n\n\nShow the code\nglm(case ~ partners * age1,\n    family = binomial,\n    data = mwanza)|&gt; \n  tbl_regression(exponentiate = T) |&gt; \n  add_global_p(keep=T)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nOR\n95% CI\np-value\n\n\n\n\npartners\n\n\n\n\n0.018\n\n\n    2-4\n—\n—\n\n\n\n\n    &lt;=1\n0.44\n0.10, 1.78\n0.2\n\n\n    &gt;=5\n5.12\n0.99, 27.1\n0.048\n\n\nage1\n\n\n\n\n&lt;0.001\n\n\n    1\n—\n—\n\n\n\n\n    2\n3.98\n1.52, 12.6\n0.009\n\n\n    3\n3.20\n1.14, 10.5\n0.037\n\n\n    4\n2.23\n0.77, 7.44\n0.2\n\n\n    5\n1.60\n0.55, 5.32\n0.4\n\n\n    6\n0.70\n0.20, 2.60\n0.6\n\n\npartners * age1\n\n\n\n\n0.5\n\n\n    &lt;=1 * 2\n1.06\n0.20, 5.62\n&gt;0.9\n\n\n    &gt;=5 * 2\n0.26\n0.04, 1.62\n0.14\n\n\n    &lt;=1 * 3\n0.62\n0.08, 4.12\n0.6\n\n\n    &gt;=5 * 3\n0.30\n0.05, 1.90\n0.2\n\n\n    &lt;=1 * 4\n1.62\n0.24, 10.5\n0.6\n\n\n    &gt;=5 * 4\n0.35\n0.05, 2.25\n0.3\n\n\n    &lt;=1 * 5\n0.70\n0.07, 5.21\n0.7\n\n\n    &gt;=5 * 5\n0.41\n0.06, 2.65\n0.3\n\n\n    &lt;=1 * 6\n5.19\n0.77, 35.7\n0.088\n\n\n    &gt;=5 * 6\n0.51\n0.06, 4.33\n0.5\n\n\n\nAbbreviations: CI = Confidence Interval, OR = Odds Ratio\n\n\n\n\n\n\n\n\nShow the code\n# Model with interaction\nlogit_inter &lt;- glm(case ~ partners * age1,\n    family = binomial,\n    data = mwanza)\n\n# Model without interaction\nlogit_without &lt;- glm(case ~ partners + age1,\n    family = binomial,\n    data = mwanza)\n\n# Likelihood ratio test\nlmtest::lrtest(logit_without, logit_inter)\n\n\nLikelihood ratio test\n\nModel 1: case ~ partners + age1\nModel 2: case ~ partners * age1\n  #Df LogLik Df Chisq Pr(&gt;Chisq)\n1   8   -385                    \n2  18   -380 10  9.43       0.49\n\n\n\n\n\n\n\n\nAnswer\n\n\n\n\n\nUsing partners variable in the analysis and conducting the interaction and no interaction model, the data are compatible with null hypothesis of no interaction: LRT gives \\(\\chi_{10}^2\\)=9.43, p=0.49.",
    "crumbs": [
      "Home",
      "2: Review of Logistic Regression"
    ]
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "LSHTM - ASME",
    "section": "",
    "text": "This site contains the solutions in R for Advanced Statistical Methods in Epidemiology (2412)"
  },
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "About",
    "section": "",
    "text": "About this site\n\n1 + 1\n\n[1] 2"
  },
  {
    "objectID": "ASME_04.html",
    "href": "ASME_04.html",
    "title": "3: Matched case-control studies",
    "section": "",
    "text": "Show the code\n# Data wrangling\n# read \"dta\" files\nlibrary(haven) \n# create table\nlibrary(gtsummary)\n# data wrangling and other functions\nlibrary(tidyverse)\n# if you want to have a output similar to stata\nlibrary(tidylog)\nlibrary(epiDisplay) #some basic tests\n# Limit significant digits to 2, remove scientific notation\nlibrary(survival)\noptions(digits = 2, scipen = 9)\nShow the code\ndiabraz &lt;- read_dta(\"datasets/DIABRAZ.DTA\")\ndiabraz2 &lt;- read_dta(\"datasets/DIABRAZ2.DTA\")\nShow the code\n# * BRAZILIAN CASE-CONTROL STUDY OF RISK FACTORS FOR INFANT DEATH FROM DIARRHOEA\n# * case       1=case, 0=control\n# * milkgp     1=breast only, 2=breast+other, 3=other only\n# * bf         1=breastfed, 2=not breastfed\n# * water      Piped water supply: 1=in house, 2=in plot, 3=none\n# * wat2       1=in house/plot 2=none\n# * agegp      Age group (months): 1=0-1, 2=2-3, 3=4-5, 4=6-8, 5=9-11\n# * agegp2     1=0-2, 2=3-5, 3=6-11\n# * milkgp     1=breast only, 2=breast+other, 3=other only\n# Check the class of each variable\nglimpse(diabraz)\nglimpse(diabraz2)\n# case need to be numeric\ndiabraz2$case &lt;- as.numeric(diabraz2$case)",
    "crumbs": [
      "Home",
      "3: Matched case-control studies"
    ]
  },
  {
    "objectID": "ASME_04.html#mantel-haenszel",
    "href": "ASME_04.html#mantel-haenszel",
    "title": "3: Matched case-control studies",
    "section": "Mantel-Haenszel",
    "text": "Mantel-Haenszel\n\n\nShow the code\ndiabraz |&gt;\n  pubh::mhor(case ~ pair / bf)\n\n\n\n              OR Lower.CI Upper.CI Pr(&gt;|z|)\n(Intercept) 1.11     0.60     2.05    0.740\npair        0.97     0.95     0.99    0.015\npair:bf     1.02     1.01     1.03    0.005\n\n                          Common OR Lower CI Upper CI Pr(&gt;|z|)\nCochran-Mantel-Haenszel:        4.8        2       12  &lt; 0.001\n\nTest for effect modification (interaction): p =  0.65 \n \n\n\nShow the code\n# Other option\n#epiDisplay::mhor(diabraz$case, diabraz$bf, diabraz$pair, graph = F)",
    "crumbs": [
      "Home",
      "3: Matched case-control studies"
    ]
  },
  {
    "objectID": "ASME_04.html#conditional-logistic-regression",
    "href": "ASME_04.html#conditional-logistic-regression",
    "title": "3: Matched case-control studies",
    "section": "Conditional Logistic regression",
    "text": "Conditional Logistic regression\n\nShow the code\nclogit_mod &lt;- clogit(case ~ bf + strata(pair), diabraz)\ntbl_regression(clogit_mod, exponentiate = T)\n\n\n\n\n\n\n\nCharacteristic\nOR\n95% CI\np-value\n\n\n\n\nMilk, 2 groups\n4.83\n2.01, 11.6\n&lt;0.001\n\n\n\nAbbreviations: CI = Confidence Interval, OR = Odds Ratio",
    "crumbs": [
      "Home",
      "3: Matched case-control studies"
    ]
  },
  {
    "objectID": "ASME_04.html#unconditional-logistic-regression",
    "href": "ASME_04.html#unconditional-logistic-regression",
    "title": "3: Matched case-control studies",
    "section": "Unconditional Logistic regression",
    "text": "Unconditional Logistic regression\n\nShow the code\nunclogit_mod &lt;- glm(case ~ bf, diabraz, family = binomial)\ntbl_regression(unclogit_mod, exponentiate = T)\n\n\n\n\n\n\n\nCharacteristic\nOR\n95% CI\np-value\n\n\n\n\nMilk, 2 groups\n3.00\n1.62, 5.63\n&lt;0.001\n\n\n\nAbbreviations: CI = Confidence Interval, OR = Odds Ratio",
    "crumbs": [
      "Home",
      "3: Matched case-control studies"
    ]
  },
  {
    "objectID": "ASME_06.html",
    "href": "ASME_06.html",
    "title": "06: Stratifying on time for cohort studies",
    "section": "",
    "text": "Show the code\n# read \"dta\" files\nlibrary(haven) \n# create table\nlibrary(gtsummary)\n# data wrangling and other functions\nlibrary(tidyverse)\n# if you want to have a output similar to stata\nlibrary(tidylog)\n#cox\nlibrary(survival)\n# plots survival\nlibrary(ggsurvfit)\n# Limit significant digits to 2, remove scientific notation\noptions(digits = 2, scipen = 9)\n\n\n\nQ1\nOpen a log file, change to the directory where your ASME data have been copied and then read the Whitehall data, whitehal.dta. In this practical we are interested in the effect of job grade on CHD mortality.\n\n\nShow the code\nwhitehall &lt;- read_stata(\"datasets/WHITEHAL.DTA\")\n\n# data wrangling\nwhitehall &lt;- whitehall |&gt; \n  mutate(\n    id = as.integer(id),\n    all = as.integer(all), # NB outcomes must remain numerical\n    chd = as.integer(chd),\n    grade4 = case_when( # recoding as character using case_when, most models will recognize characters as factors with some exemptions (mgcv doesnt)\n      grade4 == 1 ~ \"admin\",\n      grade4 == 2 ~ \"profess\",\n      grade4 == 3 ~ \"clerical\",\n      grade4 == 4 ~ \"other\"\n    ),\n    smok = case_when(\n      smok == 1 ~ \"never\",\n      smok == 2 ~ \"ex\",\n      smok == 3 ~ \"1-14/day\",\n      smok == 4 ~ \"15-24/day\",\n      smok == 5 ~ \"25+/day\"\n    ),\n    grade = case_when(\n      grade == 1 ~ \"higher\",\n      grade == 2 ~ \"lower\"),\n    cholgrp = as.factor(cholgrp),\n    sbpgrp = as.factor(sbpgrp))\n\n\n\n\nQ2\nCompute the rates for the two grades of employment categories using the commands below. pyears()\nIn days\n\nShow the code\n# Calculate rates\npyears(Surv(time = as.numeric(timein), \n                                 time2 = as.numeric(timeout), \n                                 event = chd) ~ grade, data = whitehall, scale = 1) %&gt;%\n  summary(n = F, rate = T, ci.r = T, scale = 1000)\n\nCall: pyears(formula = Surv(time = as.numeric(timein), time2 = as.numeric(timeout), event = chd) ~ grade, data = whitehall, scale = 1)\nnumber of observations = 1677\n\n\n\ngrade\nEvents\nTime\nEvent rate\nCI (rate)\n\n\n\n\nhigher\n90\n7429107\n0.012\n0.0097 - 0.015\n\n\nlower\n64\n2653754\n0.024\n0.0186 - 0.031\n\n\n\nIn years\n\nShow the code\n# Calculate rates\npyears(Surv(time = as.numeric(timein), \n                                 time2 = as.numeric(timeout), \n                                 event = chd) ~ grade, data = whitehall) %&gt;%\n  summary(n = F, rate = T, ci.r = T, scale = 1000)\n\nCall: pyears(formula = Surv(time = as.numeric(timein), time2 = as.numeric(timeout), event = chd) ~ grade, data = whitehall)\nnumber of observations = 1677\n\n\n\ngrade\nEvents\nTime\nEvent rate\nCI (rate)\n\n\n\n\nhigher\n90\n20340\n4.4\n3.6 - 5.4\n\n\nlower\n64\n7266\n8.8\n6.8 - 11.2\n\n\n\n\n\n\n\n\n\nCoding explanation\n\n\n\n\n\nCalculate rates stratified by exposure (the two grades of employment: grade).\nYou create a survival object with Surv(); it contains duration of follow-up and status at end of follow-up. You dont need to setup it globally as in STATA. You have freedom to use different timescales for each model\nYou then calculate stratified rates pyears(): in the formula, you use a Surv object, and then the stratification; you then pipe this into summary()\nThe argument “scale” from pyears() is to scaling the results, for example if your time is in days and want to report in years use scale = 365.25 (the default value)\n\n\n\nCalculate the RR by hand (from the two rates shown on the screen).\n\n\n\n\n\n\nAnswer\n\n\n\n\n\n\\(\\frac{8.8}{4.4}=2\\)\n\n\n\n\n\nQ3\nNow, set again the time and outcome variables with stset but this time, use the time of birth as the origin, i.e. organise the data according to current age.\n\nShow the code\n# Calculate rates\npyears(Surv(time = as.numeric(timein), \n                                 time2 = as.numeric(timeout), \n            origin = as.numeric(timebth),\n                                 event = chd) ~ grade, data = whitehall) %&gt;%\n  summary(n = F, rate = T, ci.r = T, scale = 1000)\n\nCall: pyears(formula = Surv(time = as.numeric(timein), time2 = as.numeric(timeout), origin = as.numeric(timebth), event = chd) ~ grade, data = whitehall)\nnumber of observations = 1677\n\n\n\ngrade\nEvents\nTime\nEvent rate\nCI (rate)\n\n\n\n\nhigher\n90\n20340\n4.4\n3.6 - 5.4\n\n\nlower\n64\n7266\n8.8\n6.8 - 11.2\n\n\n\n\n\nShow the code\n# I dont know any easy alternative to see the summary (similar to STATA)\nsummary(Surv(as.numeric(whitehall$timein)/365.25, \n     as.numeric(whitehall$timeout)/365.25,\n     origin = as.numeric(whitehall$timebth)/365.25,\n     whitehall$chd))\n\n\n     start         stop        status    \n Min.   :40   Min.   :44   Min.   :0.00  \n 1st Qu.:47   1st Qu.:64   1st Qu.:0.00  \n Median :52   Median :68   Median :0.00  \n Mean   :52   Mean   :69   Mean   :0.09  \n 3rd Qu.:57   3rd Qu.:73   3rd Qu.:0.00  \n Max.   :69   Max.   :86   Max.   :1.00  \n\n\n\n\nQ4, Q5 and Q6\nNext we need to split the individual follow-up times into intervals specific to different agebands.\nUse the stsplit command to create 5-years groups of current age between age 50 and 80 and 10-year groups for the youngest and oldest groups.\n\nShow the code\n# dividing by 365.25 to transform in years instead days\n# the variables used in time, time2,origin will be removed from the new dataset\nwhite_split &lt;- survSplit(\n  Surv(\n    time = as.numeric(timein) / 365.25,\n    time2 = as.numeric(timeout) / 365.25,\n    event = chd,\n    origin = as.numeric(timebth) / 365.25\n  ) ~ .,\n  data = whitehall,\n  cut = c(40, seq(50, 80, 5), 90),\n  episode = \"ageband\"\n)\n\nwhite_split |&gt;  filter(id == \"5001\") |&gt; \n  select(id,\n         tstart, tstop, ageband) |&gt; \n  left_join(whitehall |&gt; \n              select(id,timein,timeout,timebth) |&gt; \n              mutate(age_enter = (timein-timebth)/365.25)) |&gt; \n  gt::gt()\n\n\n\n\n\n\n\nid\ntstart\ntstop\nageband\nDate of entry (days)\nDate of exit (days)\nDate of birth (days)\nage_enter\n\n\n\n\n5001\n47\n50\n2\n1967-09-13\n1987-01-30\n1920-03-20\n47.4825448643908\n\n\n5001\n50\n55\n3\n1967-09-13\n1987-01-30\n1920-03-20\n47.4825448643908\n\n\n5001\n55\n60\n4\n1967-09-13\n1987-01-30\n1920-03-20\n47.4825448643908\n\n\n5001\n60\n65\n5\n1967-09-13\n1987-01-30\n1920-03-20\n47.4825448643908\n\n\n5001\n65\n67\n6\n1967-09-13\n1987-01-30\n1920-03-20\n47.4825448643908\n\n\n\n\n\n\n\nQ7\nNote that there is no change in the information about length of follow-up\n\n\nShow the code\n# Stratify by grade\n# use scale =1 because the time is already in years\npyears(Surv(tstart, tstop,chd) ~ grade,\n       data = white_split,\n       scale=1) %&gt;%\n  summary(n = F, rate = T, ci.r = T, scale = 1000)\n\n\nCall: pyears(formula = Surv(tstart, tstop, chd) ~ grade, data = white_split, \n    scale = 1)\n\nnumber of observations = 6920\n\n grade    Events   Time    Event rate   CI (rate)   \n-------- -------- ------- ------------ ------------ \n higher     90     20340      4.4       3.6 -  5.4 \n lower      64      7266      8.8       6.8 - 11.2 \n\n\n\n\nQ8\nTabulate by agebands now\n\nShow the code\npyears(Surv(tstart, tstop,chd) ~ ageband,\n       data = white_split,\n       scale=1) |&gt; \n  summary(n = T, rate = T, ci.r = T, scale = 1000) #use n=T to see the number of individuals who were followed in each ageband\n\nCall: pyears(formula = Surv(tstart, tstop, chd) ~ ageband, data = white_split, scale = 1)\nnumber of observations = 6920\n\n\n\nageband\nN\nEvents\nTime\nEvent rate\nCI (rate)\n\n\n\n\n2\n722\n1\n3138\n0.32\n0.0081 - 1.8\n\n\n3\n1078\n9\n4427\n2.03\n0.9296 - 3.9\n\n\n4\n1400\n17\n6003\n2.83\n1.6496 - 4.5\n\n\n5\n1500\n38\n6166\n6.16\n4.3614 - 8.5\n\n\n6\n1149\n41\n4398\n9.32\n6.6898 - 12.6\n\n\n7\n686\n29\n2442\n11.87\n7.9517 - 17.1\n\n\n8\n311\n15\n912\n16.45\n9.2047 - 27.1\n\n\n9\n74\n4\n118\n33.78\n9.2032 - 86.5\n\n\n\n\n\nQ9\nCalculate the ageband-specific RRs for Low grade versus High grade using stmh and assess whether the effect of grade is the same across all the strata. Is it necessary to report the stratum specific estimates? Do you think that age confounds the relationship between job grade and CHD mortality?\n\n\nShow the code\npyears(Surv(tstart, tstop,chd) ~ ageband+grade,\n       data = white_split,\n       scale=1)|&gt; \n  summary(n = T, rate = T, ci.r = T, scale = 1000) \n\n\nCall: pyears(formula = Surv(tstart, tstop, chd) ~ ageband + grade, \n    data = white_split, scale = 1)\n\nnumber of observations = 6920\n\n---------- \n    N     \n  Events  \n   Time   \nEvent rate\nCI (rate) \n---------- \n\n--------------------------------------- \n             grade                      \nageband     higher           lower      \n------- --------------- --------------- \n              603             119       \n                0               1       \n   2        2667.9           470.4      \n               0.0             2.1      \n          0.000-  1.383   0.054- 11.843 \n \n              871             207       \n                6               3       \n   3        3650.2           776.8      \n               1.6             3.9      \n          0.603-  3.578   0.796- 11.287 \n \n             1074             326       \n               12               5       \n   4        4737.2          1266.0      \n               2.5             3.9      \n          1.309-  4.425   1.282-  9.216 \n \n             1080             420       \n               21              17       \n   5        4493.7          1672.0      \n               4.7            10.2      \n          2.893-  7.144   5.923- 16.279 \n \n              779             370       \n               21              20       \n   6        2900.6          1497.5      \n               7.2            13.4      \n          4.482- 11.067   8.158- 20.626 \n \n              425             261       \n               20               9       \n   7        1407.6          1034.9      \n              14.2             8.7      \n          8.679- 21.944   3.977- 16.509 \n \n              163             148       \n                9               6       \n   8         440.4           471.7      \n              20.4            12.7      \n          9.344- 38.793   4.668- 27.688 \n \n               31              43       \n                1               3       \n   9          42.2            76.2      \n              23.7            39.4      \n          0.600-132.056   8.116-115.009 \n--------------------------------------- \n\n\nShow the code\n# To get the RR of grade adjusted for ageband, we need additional steps\n\ndt_rates &lt;- pyears(Surv(tstart, tstop,chd) ~ ageband+grade,\n       data = white_split,\n       scale=1,\n       data.frame = T) \n# ageband is coded as numeric in the output\ndt_rates$data$ageband &lt;- as.factor(dt_rates$data$ageband)\ndt_mh &lt;- dt_rates$data |&gt; arrange(desc(grade))\n\n\nPainful to do MH in R\n\n\nShow the code\ndat.tab04 &lt;- sapply(2:length(unique(dt_mh$ageband)), function(x) \n   as.matrix(dt_mh[dt_mh$ageband == x,c(5,3)], ncol = 2, byrow = TRUE), \n   simplify = \"array\")\nepiR::epi.2by2(dat = dat.tab04, method = \"cohort.time\", digits = 2, \n   conf.level = 0.95, interpret = FALSE, \n   outcome = \"as.columns\")\n\n\n             Outcome +     Time at risk                 Inc rate *\nExposed +           61 7189.35230511529        0.85 (0.65 to 1.09)\nExposed -           89 20297.5953348253        0.44 (0.35 to 0.54)\nTotal              150 27486.9476399405        0.55 (0.46 to 0.64)\n\nPoint estimates and 95% CIs:\n-------------------------------------------------------------------\nInc rate ratio (crude)                         1.94 (1.37, 2.71)\nInc rate ratio (M-H)                           1.38 (1.01, 1.90)\nInc rate ratio (crude:M-H)                     1.40\nAttrib rate in the exposed (crude) *           0.41 (0.178, 0.642)\nAttrib rate in the exposed (M-H) *             0.22 (-0.016, 0.465)\nAttrib rate (crude:M-H)                        1.83\n-------------------------------------------------------------------\n Wald confidence limits\n M-H: Mantel-Haenszel; CI: confidence interval\n * Outcomes per 100 units of population time at risk \n\n\nModel based is way better\n\n\nShow the code\nmod1 &lt;-  glm(event ~ grade + ageband + offset(log(pyears)),\n      family = poisson,\n      data= dt_rates$data) \nmod_int &lt;-  glm(event ~ grade*ageband + offset(log(pyears)),\n      family = poisson,\n      data= dt_rates$data) \ntbl_regression(mod1,exponentiate = T)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nIRR\n95% CI\np-value\n\n\n\n\ngrade\n\n\n\n\n\n\n\n\n    higher\n—\n—\n\n\n\n\n    lower\n1.41\n1.01, 1.96\n0.040\n\n\nageband\n\n\n\n\n\n\n\n\n    2\n—\n—\n\n\n\n\n    3\n6.32\n1.19, 117\n0.080\n\n\n    4\n8.68\n1.78, 156\n0.036\n\n\n    5\n18.5\n4.01, 328\n0.004\n\n\n    6\n27.2\n5.92, 483\n0.001\n\n\n    7\n33.7\n7.18, 601\n&lt;0.001\n\n\n    8\n45.2\n9.10, 819\n&lt;0.001\n\n\n    9\n88.9\n13.1, 1,746\n&lt;0.001\n\n\n\nAbbreviations: CI = Confidence Interval, IRR = Incidence Rate Ratio\n\n\n\n\n\n\n\n\nCheck interaction\n\n\nShow the code\nlmtest::lrtest(mod1,mod_int)\n\n\nLikelihood ratio test\n\nModel 1: event ~ grade + ageband + offset(log(pyears))\nModel 2: event ~ grade * ageband + offset(log(pyears))\n  #Df LogLik Df Chisq Pr(&gt;Chisq)  \n1   9  -35.4                      \n2  16  -28.7  7  13.4      0.063 .\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nDifferent answers from STATA output. Here, we are modelling it using Poisson and testing interaction using a likelihood test. Instead, in the Stata solutions it is with stratified rate ratios (Mantel-Haenszel)\nAll subsequent questions will be answered using model based / likelihood ratio tests for interactions\n\n\nQ10\nUsing strate and stmh examine (a) the effect of smoking on CHD mortality, (b) whether smoking confounds the relationship between job grade and CHD mortality. You may wish to recode the smoking variable into three categories (i) never, (ii) ex, (iii) current smokers\n\n\nShow the code\n# Recode\nwhite_split &lt;- white_split |&gt; \n  mutate(smok3 = as.factor(case_when(smok == \"never\" ~ \"never\",\n                                     smok == \"ex\" ~ \"ex\",\n                                     smok == \"1-14/day\" ~ \"current\",\n                                     smok == \"15-24/day\" ~ \"current\",\n                                     smok == \"25+/day\" ~ \"current\")),\n         smok3 = fct_relevel(smok3, \"never\", \"ex\", \"current\"))# Order level\n\n\n\npyears(Surv(tstart, tstop,chd) ~ smok3+grade,\n       data = white_split,\n       scale=1)|&gt; \n  summary(n = T, rate = T, ci.r = T, scale = 1000) \n\n\nCall: pyears(formula = Surv(tstart, tstop, chd) ~ smok3 + grade, data = white_split, \n    scale = 1)\n\nnumber of observations = 6920\n\n---------- \n    N     \n  Events  \n   Time   \nEvent rate\nCI (rate) \n---------- \n\n------------------------------- \n           grade                \n smok3    higher       lower    \n------- ----------- ----------- \n           1094         245     \n              6           5     \n never    4603.9       988.2    \n             1.3         5.1    \n         0.48- 2.84  1.64-11.81 \n \n           2116         595     \n             38          17     \n  ex      8462.5      2308.1    \n             4.5         7.4    \n         3.18- 6.16  4.29-11.79 \n \n           1816        1054     \n             46          42     \ncurrent   7273.5      3969.3    \n             6.3        10.6    \n         4.63- 8.44  7.63-14.30 \n------------------------------- \n\n\nShow the code\n# To get the RR of grade adjusted for ageband, we need additional steps\n\ndt_rates &lt;- pyears(Surv(tstart, tstop,chd) ~ smok3+grade,\n       data = white_split,\n       scale=1,\n       data.frame = T) \ndt_mh &lt;- dt_rates$data \n\n\n\n\nShow the code\nmod1 &lt;-  glm(event ~ grade + smok3 + offset(log(pyears)),\n      family = poisson,\n      data= dt_rates$data) \nmod_int &lt;-  glm(event ~ grade*smok3 + offset(log(pyears)),\n      family = poisson,\n      data= dt_rates$data) \ntbl_regression(mod1,exponentiate = T)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nIRR\n95% CI\np-value\n\n\n\n\ngrade\n\n\n\n\n\n\n\n\n    higher\n—\n—\n\n\n\n\n    lower\n1.76\n1.27, 2.43\n&lt;0.001\n\n\nsmok3\n\n\n\n\n\n\n\n\n    never\n—\n—\n\n\n\n\n    ex\n2.53\n1.38, 5.10\n0.005\n\n\n    current\n3.56\n1.98, 7.08\n&lt;0.001\n\n\n\nAbbreviations: CI = Confidence Interval, IRR = Incidence Rate Ratio\n\n\n\n\n\n\n\n\nCheck interaction\n\n\nShow the code\nlmtest::lrtest(mod1,mod_int)\n\n\nLikelihood ratio test\n\nModel 1: event ~ grade + smok3 + offset(log(pyears))\nModel 2: event ~ grade * smok3 + offset(log(pyears))\n  #Df LogLik Df Chisq Pr(&gt;Chisq)\n1   4  -15.2                    \n2   6  -14.3  2  1.74       0.42\n\n\n\n\nQ11\nExamine the effect of job grade on CHD mortality adjusted for ageband and smoking simultaneously. What do you conclude about the effect of job grade on CHD mortality having adjusted for both of these factors together?\n\n\nShow the code\npyears(Surv(tstart, tstop,chd) ~ smok3+grade+ageband,\n       data = white_split,\n       scale=1)|&gt; \n  summary(n = T, rate = T, ci.r = T, scale = 1000) \n\n\nCall: pyears(formula = Surv(tstart, tstop, chd) ~ smok3 + grade + ageband, \n    data = white_split, scale = 1)\n\nnumber of observations = 6920\n\n---------- \n    N     \n  Events  \n   Time   \nEvent rate\nCI (rate) \n---------- \n\n: ageband=2 \n--------------------------------------- \n             grade                      \n smok3      higher           lower      \n------- --------------- --------------- \n              162              21       \n                0               0       \n never       848.37           85.47     \n               0.00            0.00     \n          0.000-  4.348   0.000- 43.161 \n \n              221              35       \n                0               0       \n  ex         907.18          140.02     \n               0.00            0.00     \n          0.000-  4.066   0.000- 26.346 \n \n              220              63       \n                0               1       \ncurrent      912.38          244.96     \n               0.00            4.08     \n          0.000-  4.043   0.103- 22.745 \n--------------------------------------- \n: ageband=3 \n--------------------------------------- \n             grade                      \n smok3      higher           lower      \n------- --------------- --------------- \n              215              29       \n                0               0       \n never       935.63          124.46     \n               0.00            0.00     \n          0.000-  3.943   0.000- 29.640 \n \n              341              62       \n                1               1       \n  ex        1412.29          227.72     \n               0.71            4.39     \n          0.018-  3.945   0.111- 24.467 \n \n              315             116       \n                5               2       \ncurrent     1302.28          424.60     \n               3.84            4.71     \n          1.247-  8.960   0.570- 17.015 \n--------------------------------------- \n: ageband=4 \n--------------------------------------- \n             grade                      \n smok3      higher           lower      \n------- --------------- --------------- \n              247              41       \n                1               1       \n never      1118.70          166.52     \n               0.89            6.01     \n          0.023-  4.980   0.152- 33.459 \n \n              442             102       \n                5               1       \n  ex        1909.13          398.85     \n               2.62            2.51     \n          0.850-  6.112   0.063- 13.969 \n \n              385             183       \n                6               3       \ncurrent     1709.37          700.66     \n               3.51            4.28     \n          1.288-  7.640   0.883- 12.513 \n--------------------------------------- \n: ageband=5 \n--------------------------------------- \n             grade                      \n smok3      higher           lower      \n------- --------------- --------------- \n              231              53       \n                4               0       \n never       900.08          218.29     \n               4.44            0.00     \n          1.211- 11.378   0.000- 16.899 \n \n              461             129       \n                6               3       \n  ex        1979.09          530.70     \n               3.03            5.65     \n          1.113-  6.599   1.166- 16.520 \n \n              388             238       \n               11              14       \ncurrent     1614.51          923.05     \n               6.81           15.17     \n          3.401- 12.191   8.292- 25.448 \n--------------------------------------- \n: ageband=6 \n--------------------------------------- \n             grade                      \n smok3      higher           lower      \n------- --------------- --------------- \n              140              46       \n                0               0       \n never       500.40          187.88     \n               0.00            0.00     \n          0.000-  7.372   0.000- 19.634 \n \n              355             118       \n               12               9       \n  ex        1347.42          486.21     \n               8.91           18.51     \n          4.602- 15.557   8.464- 35.139 \n \n              284             206       \n                9              11       \ncurrent     1052.77          823.42     \n               8.55           13.36     \n          3.909- 16.228   6.669- 23.903 \n--------------------------------------- \n: ageband=7 \n--------------------------------------- \n             grade                      \n smok3      higher           lower      \n------- --------------- --------------- \n               71              30       \n                1               2       \n never       231.88          126.92     \n               4.31           15.76     \n          0.109- 24.029   1.908- 56.924 \n \n              201              88       \n               10               2       \n  ex         671.00          342.64     \n              14.90            5.84     \n          7.147- 27.407   0.707- 21.086 \n \n              153             143       \n                9               5       \ncurrent      504.72          565.31     \n              17.83            8.84     \n          8.154- 33.850   2.872- 20.640 \n--------------------------------------- \n: ageband=8 \n--------------------------------------- \n             grade                      \n smok3      higher           lower      \n------- --------------- --------------- \n               24              19       \n                0               1       \n never        63.93           72.80     \n               0.00           13.74     \n          0.000- 57.706   0.348- 76.532 \n \n               81              47       \n                4               0       \n  ex         215.82          152.47     \n              18.53            0.00     \n          5.050- 47.455   0.000- 24.193 \n \n               58              82       \n                5               5       \ncurrent      160.67          246.39     \n              31.12           20.29     \n         10.104- 72.623   6.589- 47.357 \n--------------------------------------- \n: ageband=9 \n--------------------------------------- \n             grade                      \n smok3      higher           lower      \n------- --------------- --------------- \n                4               6       \n                0               1       \n never         4.87            5.87     \n               0.00          170.29     \n          0.000-756.995   4.311-948.797 \n \n               14              14       \n                0               1       \n  ex          20.55           29.48     \n               0.00           33.92     \n          0.000-179.535   0.859-188.976 \n \n               13              23       \n                1               1       \ncurrent       16.77           40.88     \n              59.62           24.46     \n          1.510-332.204   0.619-136.307 \n--------------------------------------- \n\n\nShow the code\ndt_rates &lt;- pyears(Surv(tstart, tstop,chd) ~ smok3+grade+ageband,\n       data = white_split,\n       scale=1,\n       data.frame = T)\n# ageband is coded as numeric in the output\ndt_rates$data$ageband &lt;- as.factor(dt_rates$data$ageband)\nmod1 &lt;-  glm(event ~ grade+smok3 + ageband+offset(log(pyears)),\n      family = poisson,\n      data= dt_rates$data) \ntbl_regression(mod1,exponentiate = T)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nIRR\n95% CI\np-value\n\n\n\n\ngrade\n\n\n\n\n\n\n\n\n    higher\n—\n—\n\n\n\n\n    lower\n1.27\n0.91, 1.78\n0.2\n\n\nsmok3\n\n\n\n\n\n\n\n\n    never\n—\n—\n\n\n\n\n    ex\n2.11\n1.15, 4.26\n0.024\n\n\n    current\n3.12\n1.73, 6.20\n&lt;0.001\n\n\nageband\n\n\n\n\n\n\n\n\n    2\n—\n—\n\n\n\n\n    3\n6.09\n1.15, 112\n0.086\n\n\n    4\n8.26\n1.70, 149\n0.040\n\n\n    5\n17.3\n3.76, 308\n0.005\n\n\n    6\n25.3\n5.50, 449\n0.001\n\n\n    7\n31.3\n6.67, 558\n&lt;0.001\n\n\n    8\n42.4\n8.53, 768\n&lt;0.001\n\n\n    9\n80.8\n11.9, 1,587\n&lt;0.001\n\n\n\nAbbreviations: CI = Confidence Interval, IRR = Incidence Rate Ratio\n\n\n\n\n\n\n\n\n\n\nShow the code\nmod_int &lt;-  glm(event ~ grade*smok3 + ageband+offset(log(pyears)),\n      family = poisson,\n      data= dt_rates$data) \nlmtest::lrtest(mod1,mod_int)\n\n\nLikelihood ratio test\n\nModel 1: event ~ grade + smok3 + ageband + offset(log(pyears))\nModel 2: event ~ grade * smok3 + ageband + offset(log(pyears))\n  #Df LogLik Df Chisq Pr(&gt;Chisq)\n1  11  -75.0                    \n2  13  -74.4  2  1.25       0.53\n\n\n\n\n\n\n\n\nAnswer\n\n\n\n\n\nThere is no evidence of effect modification between grade and smoking. \\(\\chi_{2}^2 = 1.25\\) and p=0.53\n\n\n\n\n\nQ12\nThe file whchd.dta holds the Whitehall data already expanded by current age and period (in 5-years periods) and has been stset for the analysis of CHD events. It also holds a variable, called rate, giving the corresponding age and period specific CHD mortality rates for England and Wales (per 1,000,000 person years). Compute the CHD SMR for the cohort of Whitehall civil servants\n\n\nShow the code\n# way more complicated than STATA (using this format of data)\n# the stranges names from stata dont work verwy well in R - use clean_names to fix\nwhcd &lt;- haven::read_dta(\"datasets/WHCHD.DTA\") |&gt; janitor::clean_names()\n# get the expected number of cases - adjusted by period, ageband and grade\n\nexpectdt &lt;- whcd |&gt; group_by(ageband, grade, period) |&gt; \n  reframe(a=mean(rate)/1e6,\n          totalpy=sum(t-t0)) |&gt; \n  reframe(e=a*totalpy) |&gt; \n  reframe(sum(e))\n\n\nobservedt &lt;- whcd |&gt; \n  reframe(sum(chd, na.rm=T))\n\npopEpi::poisson.ci(147,227)\n\n\n    x  pt rate lower upper conf.level\n1 147 227 0.65  0.55  0.76       0.95",
    "crumbs": [
      "Home",
      "06: Stratifying on time for cohort studies"
    ]
  }
]